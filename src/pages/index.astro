---
import HomeLayout from "../layouts/HomeLayout.astro";
import TagCloud from "../components/TagCloud.astro";
import { readdir } from "node:fs/promises";
import { fileURLToPath } from "node:url";
import { dirname, join } from "node:path";

export const pageTitle = "Flush";
export const pageTags = ["Home"];

/** Build-time: list SVGs in /public/images/marks (no hardcoded names) */
const __filename = fileURLToPath(import.meta.url);
const __dirname = dirname(__filename);
const marksDir = join(__dirname, "..", "..", "public", "images", "marks");

let markFiles: string[] = [];
try {
  const entries = await readdir(marksDir, { withFileTypes: true });
  markFiles = entries
    .filter((e) => e.isFile() && e.name.toLowerCase().endsWith(".svg"))
    .map((e) => `/images/marks/${e.name}`);
} catch {
  markFiles = [];
}
---

<HomeLayout title="Flush" description="Official Flush site">
  <!-- HERO: single random vector (white; masked) -->
  <section class="hero">
    <div class="hero__inner">
      <span class="hero__mark" aria-hidden="true"></span>
      <img class="hero__markImg" alt="" aria-hidden="true" />
    </div>
  </section>

  <!-- INTRO COPY -->
  <section class="intro long-text">
    <p>Hello Friend! Welcome to the Flush internets!</p>
    <p>
      Flush is a rock band from Helsinki, Finland, we like to describe ourselves as community rock.
      Once described as “an ideal band to book for funerals”, we are  bit of punk rock, quite a lot
      of alternative rock, and many other flavours of rock and metal. But most of all, we are a safe
      space or sometimes an escape for when the world feels like a bit too much. A community for those
      who don’t always fit in. A community for anyone.
    </p>
    <p>
      On this website of ours you’ll find the usual stuff you would expect from a band. Links to music,
      gigs, etc. But there will be more! There will be games, gig trackers, scrapbooks, blogs, links to
      stories you might have missed… who knows what else. So come back as we grow the site and make this
      a part of the community.
    </p>
    <p>We’re glad you found us. Welcome to our community.</p>
  </section>

  <!-- LOGO (smaller) -->
  <section class="logo-wrap">
    <img
      src="/images/logo-flush-white-orange_vex.png"
      alt="Flush"
      class="home-logo"
      loading="eager"
    />
  </section>

  <!-- TAG CLOUD -->
  <TagCloud />

  <!-- ship file list to client for per-load random pick -->
  <script type="application/json" id="marks-json">
    {JSON.stringify(markFiles)}
  </script>

  <!-- Client-side: pick one SVG per page load -->
  <script is:inline>
    (function () {
      try {
        const dataEl = document.getElementById("marks-json");
        const list = dataEl ? JSON.parse(dataEl.textContent || "[]") : [];
        const fallback = "/images/marks/us.svg"; // safe fallback if folder empty

        const pick = (arr) => arr[Math.floor(Math.random() * arr.length)];
        const chosen = (Array.isArray(list) && list.length) ? pick(list) : fallback;

        const maskEl = document.querySelector(".hero__mark");
        const imgEl  = document.querySelector(".hero__markImg");

        // Show masked (tinted white) version
        if (maskEl) {
          const url = `url('${encodeURI(chosen)}')`;
          // set both properties directly (more robust than CSS vars across browsers)
          maskEl.style.webkitMaskImage = url;
          maskEl.style.maskImage = url;
          maskEl.classList.add("is-ready");
        }
        // Fallback <img> if masks unsupported
        if (imgEl) imgEl.src = chosen;
      } catch {}
    })();
  </script>

  <style>
    /* Only local hero styles – we don't touch any site-wide containers or footer/header */
    .hero { background: var(--flush-black); padding-block: clamp(2.2rem, 7vw, 6rem); }
    .hero__inner {
      max-width: 1100px;              /* match repo container */
      margin-inline: auto;
      padding-inline: 1rem;
      display: grid;
      place-items: center;
    }

    /* Random vector as white mask (with image fallback) */
    .hero__mark{
      display: none;                   /* shown when JS sets mask */
      width: clamp(260px, 70vw, 680px);
      height: auto;
      aspect-ratio: 16 / 10;           /* generic ratio; mask-size:contain preserves original */
      background: var(--flush-light);
      filter: drop-shadow(0 8px 18px rgba(0,0,0,.35));
      opacity: .96;

      -webkit-mask-repeat: no-repeat;  mask-repeat: no-repeat;
      -webkit-mask-position: center;   mask-position: center;
      -webkit-mask-size: contain;      mask-size: contain;
    }
    .hero__mark.is-ready { display: block; }

    .hero__markImg{
      display: block;
      width: clamp(260px, 70vw, 680px);
      height: auto;
      filter: drop-shadow(0 8px 18px rgba(0,0,0,.35));
      opacity: .96;
    }
    @supports (mask-image: url("")) or (-webkit-mask-image: url("")){
      .hero__markImg { display: none; }
    }

    /* Intro copy (uses .long-text → Montserrat from your repo) */
    .intro{
      max-width: 760px;
      margin: 1.5rem auto 1rem;
      padding-inline: 1rem;
      color: var(--flush-light);
    }

    /* Smaller vexed logo centered */
    .logo-wrap{ display: grid; place-items: center; margin: 2rem 0; }
    .home-logo{ width: clamp(160px, 32vw, 280px); height: auto; display: block; filter: drop-shadow(0 6px 14px rgba(0,0,0,.45)); }
  </style>
</HomeLayout>
